---
title: "Exploratory Data Analysis: Firearm Stores Proximity and School Shooting Incidents"
author: "Falco and Michelle"
date: "7/25/2022"
output:
  html_document:
    code_folding: show
    toc: true
---

# Introduction and Load Data

In the following document we depict the code used to perform the exploratory data analyses and causal analyses for our project on firearm stores proximity and school shooting incidents. This code is stored in a GitHub repository at <https://github.com/NSAPH/firearm_store_proximity_school_shootings>. In the same repository, we stored code to:

1. Perform data cleaning and wrangling: `make_datasets.R`,

2. Generate plots for exploratory data analysis: `make_maps_plots.R`.

3. Describe and explore data: `schools_vs_firearm_stores_exploratory_analysis.Rmd`.

4. Functions for causal inference analysis: `helper_functions.R`.

5. Perform three sets of causal inference analyses: `schools_vs_firearm_stores_discretized_exposure.Rmd` (main analysis), `schools_vs_firearm_stores_continuous_exposure.Rmd`, and `schools_vs_firearm_stores_state_level.Rmd`.

Feel free to reach out for any question regarding the following code at: <fbargaglistoffi@hsph.harvard.edu> or <michelleqin@college.harvard.edu>.

```{r setup, include=FALSE}
# Set the Working Directory
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, message = FALSE) # collapse = TRUE allows output to be hidden along with code (by code_folding)
# knitr::opts_knit$set(root.dir = '~/OneDrive - Harvard University/Research/Schools Vs Firearms')
knitr::opts_knit$set(root.dir = "/Users/s012852/Library/CloudStorage/OneDrive-SharedLibraries-HarvardUniversity/Bargagli Stoffi, Falco Joannes - Schools Vs Firearms/")
```

Load the functions used for analysis. Load the data.

```{r load-functions}
source("code/make_discretized_datasets.R")
load_packages()
library(gnm)
# library(splines)
```

```{r load-data}
cleaned_data <- read_cleaned_data_as_df()
colnames(cleaned_data)

all_confounder_names

data_analysis <- get_analysis_df(cleaned_data, treatment = "mean_total_miles", all_confounder_names)
data_analysis <- na.omit(data_analysis)
y <- data_analysis$y # to do: consider removing this line and not using a variable called y in the document (ambiguous)
a <- data_analysis$a # to do: consider removing this line and not using a variable called a in the document (ambiguous)
x <- data_analysis[, all_confounder_names]
x <- t(apply(x, 1, unlist)) # to do: consider removing this line and not using a variable called x in the document (ambiguous)
ceiling_a <- ceiling(a)
```

## Notes from Data Cleaning/Wrangling (make_datasets.R)

We exclude 13 Census tracts from our analysis because they have NA's in the treatment variable (`mean_total_miles`). (For now, we keep the 326 tracts with NA's in `mean_distance_grocery_miles` and the 14 additional tracts with NA's in `mean_distance_pharmacy_miles`.)

We exclude 19 Census tracts with total (residential) population of 0 in 2020.

We exclude 541 Census tracts in Puerto Rico because [The K-12 School Shooting Database](https://www.chds.us/ssdb/) does not cover Puerto Rico.
<!-- also because (i) all of these Census tracts are recorded as having a daytime population of 0 (which is probably wrong?) and (ii) we didn't have a 2013 NCHS urban-rural classification for them, which admittedly we're not currently using in our analysis -->

We exclude 784 Census tracts with NA's in mental health index [source of mental health data].

The following is the size of our remaining dataset.

```{r print-data-dim}
dim(cleaned_data)
```


# Variable Descriptions and Exploratory Data Analysis

The unit of analysis is any Census track with at least one school. The outcome variable is whether there was a shooting (defined as when a gun is brandished, is fired, or a bullet hits school property for any reason, regardless of the number of victims, time of day, or day of week; see justification [here](https://www.chds.us/ssdb/methods/)) between January 2014 and the end of May 2022 in that Census tract. The treatment variable is the average \emph{minimum} walking distance, within a Census tract, between each school and the nearest gun \emph{dealer} in kilometers.

Additional outcome variables -- such as weapon type, preplanned, targets (i.e., random vs targeted vs both vs neither), school level (i.e., elementary, middle, high, etc.), shooter age, source reliability -- are available for Census tracts that have had a school shooting since 2014. For the 43 tracts with 2 school shootings and 1 tract with 3 school shootings, these outcome variables are measured for the \emph{most recent} school shooting.

We have a number of potential confounders that we included in our analyses:

1. `total_population_2020`: the total population in the Census tract recorded in 2020 from [add source];

2. `housing_units_per_sq_meter`: the housing units in the Census tracts per squared meter in [add year] from [add source];

3. `log_median_hh_income`: the log transformation of the median household income in the Census tract in [add year] from [add source];

4. `schools_per_sq_meter`: the number of school per squared meter in the Census tract in [add year] from [add source];

<!-- 5. `state_fips`: the state fips code from [add source]; -->

<!-- 6. `county_fips`: the county fips code from [add source]; -->

5. `census_division`: name of U.S. division to which the Census tract belongs [(source)](https://www2.census.gov/geo/docs/maps-data/maps/reg_div.txt)

6. `log_median_hh_income_15to24`: the log transformation of the median household income for individuals aged 15 to 24 in the Census tract in [add year] from [add source];

7. `total_crime_2021`: the total crime rate in the Census tract in 2021 from [add source];

8. `dealers_per_sq_meter`: the number of gun dealers per squared meter from the Federal Firearm License (FFL) file (we restricted the analysis to Type 1, \emph{dealer in firearms other than destructive devices}, and Type 2, \emph{pawnbroker in firearms other than destructive devices}, licenses);

9. `daytime_pop_2021`: the daytime population in the Census tract in 2021 from [add source];

10. `prop_white_only`: the proportion of white population in the Census tract in [add year] from [add source];

11. `prop_black_only`: the proportion of black population in the Census tract in [add year] from [add source];

12. `prop_asian_only`: the proportion of asian population in the Census tract in [add year] from [add source];

13. `prop_multiracial`: the proportion of multiracial (individuals in that Census tract who identify as 2+ races) population in the Census tract in [add year] from [add source];

14. `prop_hispanic_latino`: the proportion of hispanic population in the Census tract in [add year] from [add source];

15. `prop_food_stamps_2019`: the proportion of people in the Census tract that benefited from food stamps in 2019 from [add source];

16. `prop_public_assist_income_2019`: the proportion of people in the Census tract that benefited from public assisted income in 2019 from [add source];

17. `prop_below_poverty_2019`: the proportion of people below the poverty level in the Census tract in 2019 from [add source];

18. `prop_without_vehicles_2019`: the proportion of people without a vehicle in the Census tract in 2019 from [add source];

19. `prop_hunted_with_shotgun_2021`: the proportion of people that hunted with a shotgun in the past 12 months in the Census tract in 2021 from [add source];

20. `prop_bachelor_deg_25plus_2021`: the proportion of people older than 25 that obtained a bachelor degree  in the Census tract (recorded in 2021) from [add source];

21. `prop_grad_deg_25plus_2021`: the proportion of people older than 25 that obtained a graduate or professional degree in the Census tract (recorded in 2021) from [add source];

22. `prop_unemployed_2021`: the proportion of people unemployed in the Census tract in 2021 from [add source];

23. `prop_unemployed_16to24_2021`: the proportion of people unemployed in the age range 16 to 24 in the Census tract in 2021 from [add source];

24. `prop_institutional_group`: the proportion of institutional population in the Census tract in [add year] from [add source];

25. `prop_noninstitutional_group`: the proportion of noninstitutional population in the Census tract in [add year] from [add source];

26. `prop_18plus`: the proportion of population older than 18 in the Census tract in [add year] from [add source];
`total_crime_2021` is computed as [add details on how this variable is generated].

27. `mental_health_index`: total number of positive severe depression, possible psychosis, PTSD, and positive suicide in the county between JAN2020 and APR2022, divided by the population of the county [source]

Most confounders are included as a proportion (for instance, of 25+ individuals who have a bachelor's degree) over that Census tract's 2020 population or area in square meters. When possible, however, we use the Census Bureau's calculated proportions, which should be better quality than dividing by 2020 population.

<!-- Several potential confounders (for instance, population of 18+ individuals) are not included in this analysis because they have correlation $>0.83$ with a confounder that is included. The only exception is `pop_below18`, which has a correlation coefficient of 0.871 with `total_population_2020`. -->

Notes about specific confounders:

- (i) There are 9 tracts with total population $<5$; none had shooting incidents; 8 of them have median household income $= 0$. (ii) There are 4 tracts (none overlapping with the 9 tracts just mentioned) with daytime population $<5$; none had shooting incidents; all have median household income $= 0$. Later, we run a sensitivity analysis excluding these low-population tracts, as well as tracts with population $<10$. (*Question: Is it weird that we have Census tracts with such small populations? Aren't Census tracts supposed to have between 1,200 and 8,000 people?)

<details>
  <summary>Census tract populations</summary>
```{r explore-population}
sum(cleaned_data$total_population_2020 < 5)
sum(cleaned_data$daytime_pop_2021 < 5)
hist(cleaned_data$total_population_2020)
hist(cleaned_data$daytime_pop_2021)
cleaned_data$binary_shooting_incident[cleaned_data$total_population_2020 < 5]
cleaned_data$binary_shooting_incident[cleaned_data$daytime_pop_2021 < 5]
cleaned_data$log_median_hh_income[cleaned_data$total_population_2020 < 5]
cleaned_data$log_median_hh_income[cleaned_data$daytime_pop_2021 < 5]

sum(cleaned_data$total_population_2020 < 1200)
sum(cleaned_data$total_population_2020 > 8000)
```
</details> 

- To gauge each Census tract's position on the urban/rural continuum, we use population density and housing unit density (over area in square meters).
- `prop_food_stamps_2019`, `prop_public_assist_income_2019`, `prop_below_poverty_2019`, and `prop_without_vehicles_2019` are the American Community Survey (ACS)'s 5-year averages over 2016-2020.
<!-- - In this analysis, we use a variable called "employmentunemployment_unage16cy_p" and call it `prop_unemployed_16to24_2021`. -->
- We are still unsure about the helpfulness of the variable "sports_mp33018a_b_p" (which we call `prop_hunted_with_shotgun_2021` in this analysis).
- `prop_multiracial` is the proportion of individuals in that Census tract who identify as 2+ races; these multiracial individuals' specific races are not included in this analysis. (Would it be illogical or strange to try to add a fraction of a person to each of their constituent races?)

<details>
  <summary>Distribution of Multiracial Populations of Census Tracts</summary>
```{r explore-multiracial, eval=TRUE}
hist(cleaned_data$prop_multiracial)
summary(cleaned_data$prop_multiracial)
```
</details>


We also have `mean_grocery_km` (containing 326 NA's), and `mean_pharmacy_km` (containing 340 NA's) in our dataset.

<details>
  <summary>Distribution of Mean Minimum Distances to Gun Dealers, Grocery Stores, and Pharmacies</summary>
```{r explore-distances}
sum(is.na(cleaned_data$mean_grocery_km))
sum(is.na(cleaned_data$mean_pharmacy_km))
round(quantile(cleaned_data$mean_total_miles), 2)
round(quantile(cleaned_data$mean_grocery_km, na.rm = TRUE), 2)
round(quantile(cleaned_data$mean_pharmacy_km, na.rm = TRUE), 2)
```
</details> 

<details>
  <summary>Distribution of Treatment (Mean Minimum Distance from School to Gun Dealer)</summary>
```{r explore-treatment}
quantile(a)
plot(density(a), main = "Distribution of Exposure (Mean Min Distance to Gun Dealer)")
plot(density(a[which(a < quantile(a, 0.99))]), main = "Distribution of Exposure (Mean Min Distance to Gun Dealer), 99th Percentile Trimmed")
plot(density(a[which(a < quantile(a, 0.95))]), main = "Distribution of Exposure (Mean Min Distance to Gun Dealer), 95th Percentile Trimmed")
plot(density(a[which(a < quantile(a, 0.90))]), main = "Distribution of Exposure (Mean Min Distance to Gun Dealer), 90th Percentile Trimmed")
```
</details>

<details>
  <summary>Nearest gun dealer vs nearest grocery store (with correlation coefficient).</summary>
    ![](/Users/s012852/Documents/figures/total_km_vs_grocery_km.png)
</details>

<details>
  <summary>Nearest gun dealer vs nearest pharmacy (with correlation coefficient).</summary>
    ![](/Users/s012852/Documents/figures/total_km_vs_pharmacy_km.png)
</details>

<details>
  <summary>Nearest grocery store vs nearest pharmacy (with correlation coefficient).</summary>
    ![](/Users/s012852/Documents/figures/grocery_km_vs_pharmacy_km.png)
</details>


<details>
  <summary>Map of school to gun store proximity (in km) at county level.</summary>
    <!-- ![](/Users/falco/Desktop/figures/counties_map_mean_km.png) -->
    ![](/Users/s012852/Documents/figures/counties_map_mean_km.png)
</details>


<details>
  <summary>Map of school to gun store proximity (in km) at state level.</summary>
    <!-- ![](/Users/falco/Desktop/figures/states_map_mean_km.png) -->
    ![](/Users/s012852/Documents/figures/states_map_mean_km.png)
</details>


<details>
  <summary>Map of school to gun store proximity (in km) at county level (trimming exposures larger than 99th percentile).</summary>
    <!-- ![](/Users/falco/Desktop/figures/counties_map_mean_km_trimmed99.png) -->
    ![](/Users/s012852/Documents/figures/counties_map_mean_km_trimmed99.png)
</details>


<details>
  <summary>Map of school to gun store proximity (in km) at state level (trimming exposures larger than 99th percentile).</summary>
    <!-- ![](/Users/falco/Desktop/figures/states_map_mean_km_trimmed99.png) -->
    ![](/Users/s012852/Documents/figures/states_map_mean_km_trimmed99.png)
</details>


<details>
  <summary>Map of school to gun store proximity (in km) at county level (trimming exposures larger than 95th percentile).</summary>
    <!-- ![](/Users/falco/Desktop/figures/counties_map_mean_km_trimmed95.png) -->
    ![](/Users/s012852/Documents/figures/counties_map_mean_km_trimmed95.png)
</details>


<details>
  <summary>Map of school to gun store proximity (in km) at state level (trimming exposures larger than 95th percentile).</summary>
    <!-- ![](/Users/falco/Desktop/figures/states_map_mean_km_trimmed95.png) -->
    ![](/Users/s012852/Documents/figures/states_map_mean_km_trimmed95.png)
</details>


<details>
  <summary>Map of gun dealers per square meter at county level.</summary>
    ![](/Users/s012852/Documents/figures/counties_map_mean_dealers.png)
</details>


<details>
  <summary>Map of gun dealers per square meter at state level.</summary>
    ![](/Users/s012852/Documents/figures/states_map_mean_dealers.png)
</details>


<details>
  <summary>Map of gun dealers per square meter at county level (above median).</summary>
    ![](/Users/s012852/Documents/figures/counties_map_mean_dealers_above_median.png)
</details>


<details>
  <summary>Map of gun dealers per square meter at state level (above median).</summary>
    ![](/Users/s012852/Documents/figures/states_map_mean_dealers_above_median.png)
</details>


<details>
  <summary>Map of gun dealers per square meter at county level (below median).</summary>
    ![](/Users/s012852/Documents/figures/counties_map_mean_dealers_below_median.png)
</details>


<details>
  <summary>Map of gun dealers per square meter at state level (below median).</summary>
    ![](/Users/s012852/Documents/figures/states_map_mean_dealers_below_median.png)
</details>

```{r explore-events}
dat <- table(ceiling_a, data_analysis$y)
events <- dat[,2]
denominator <- dat[,1]
dat <- cbind(events, denominator, events/(events + denominator))
dat
```

## Some interesting cases

```{r, echo=F, message=F}
dt <- as.data.table(cleaned_data)
```

<details>
  <summary>Year/Month of school shootings</summary>
```{r}
Date <- as.Date(dt[binary_shooting_incident == 1, Date])
hist(year(Date))
hist(month(Date), breaks = 12)
sum(is.na(Date))
```
</details>

<details>
  <summary>Time of school shootings</summary>
```{r}
time <- dt[!Time_Period %in% c("", "null"), Time_Period]
length(time)
table(time)
```
</details>

<details>
  <summary>Shooter Ages</summary>
```{r}
# incidents where exact shooter age is known
shooter_age_integer <- dt[binary_shooting_incident == 1 & !shooter_age %in% c("Adult", "Child", "Minor", "Teen", "null"), .(count_school_shootings, Date, shooter_age = as.integer(shooter_age), Narrative, Summary, Situation, Targets)]
shooter_age_integer <- shooter_age_integer[!is.na(shooter_age)]
nrow(shooter_age_integer)
summary(shooter_age_integer$shooter_age)
hist(shooter_age_integer$shooter_age, main = "Shooter Age", xlab = paste0("n = ", nrow(shooter_age_integer), " (out of ", nrow(dt[binary_shooting_incident == 1]), " shooting incidents total)"))

# incidents where shooter age is categorized (exact age unknown)
shooter_age_categorical <- dt[binary_shooting_incident == 1 & shooter_age %in% c("Adult", "Child", "Minor", "Teen"), shooter_age]
table(shooter_age_categorical)
```
</details>

```{r}
# extreme ages
shooter_age_integer[shooter_age < 10]
shooter_age_integer[shooter_age > 70]
```

<details>
  <summary>School level of school shootings</summary>
```{r}
school_level <- dt[!School_Level %in% c("", "null", "Unknown"), School_Level]
length(school_level)
table(school_level)
```
</details>


Accidental school shootings:
```{r}
accidents <- dt[binary_shooting_incident == 1 & str_detect(Situation, "Accident"),
                       .(count_school_shootings, Date, Preplanned, Narrative, Situation, Targets)]
nrow(accidents)
accidents[1:10,]
```

Shootings off school property:
```{r}
off_property <- as.data.table(cleaned_data)[binary_shooting_incident == 1 & Location_Type == "Off School Property",
                             .(count_school_shootings, Date, Location, Location_Type, Narrative, Summary, Situation)]
nrow(off_property)
off_property[1:10, ]
```


# Naive/Preliminary Data Analysis

Run a logistic regression to explore the associations between the treatment and the outcome controlling for all the confounders.

```{r naive-logistic, message=FALSE}
data_discretized_treatment <- discretize_treatment(data_analysis)

# Logistic Regression (unrestricted a, 56,470 observations)
logistic_model <- glm(y ~ ., 
                      data = data_analysis[, c("y", "a", all_confounder_names)], 
                      family = "binomial")
summary(logistic_model)
dim(data_analysis)
```

Do the same thing but with exposure trimmed at the 95th percentile.

```{r naive-logistic-trimmed}
# Logistic Regression (a trimmed at 95th percentile, 53,646 observations)
data_trim_exposure <- data_analysis[which(data_analysis$a < quantile(data_analysis$a, 0.95)), ]
logistic_model_trimmed_exposure <- glm(y ~ ., 
                      data = data_trim_exposure[, c("y", "a", all_confounder_names)], 
                      family = "binomial")
summary(logistic_model_trimmed_exposure)
dim(data_trim_exposure)
```

Do the same thing but on discretized exposure.

```{r naive-logistic-discretized}
# Logistic Regression (a has four levels, ? observations)
logistic_model_discrete_exposure <- glm(y ~ ., 
                      data = data_discretized_treatment[, c("y", "a", all_confounder_names)], 
                      family = "binomial")
summary(logistic_model_discrete_exposure)
dim(data_discretized_treatment)
```

Run a negative binomial regression to explore the associations between the treatment and the outcome controlling for all the confounders.

```{r naive-neg-bin, message=FALSE}
# Negative Binomial
negative_binomial <- glm.nb(y ~ ., data = data_analysis[, c("y", "a", all_confounder_names)])
summary(negative_binomial)

# Zero Inflated Negative Binomial
zinb <- zeroinfl(y ~ a | a ,
                 dist = "negbin", data = data_analysis)
summary(zinb)
```

Run a spline regression, with and without the covariates.

```{r spline-lm-3knots}
# Note: this is a linear model, not logistic

a_lims <- range(data_trim_exposure$a)
a_grid <- seq(a_lims[1], a_lims[2], length.out = 100)

spline1 <- lm(y ~ bs(a, bs='cr', k=3), data = data_trim_exposure)
spline_pred1 <- predict(spline1, newdata = list(a = a_grid), se = T)
plot(a_grid, spline_pred1$fit, type = "l", col = "red", lwd = 3)
lines(a_grid, spline_pred1$fit + 2*spline_pred1$se.fit, lty = "dashed", lwd = 2, col = "green")
lines(a_grid, spline_pred1$fit - 2*spline_pred1$se.fit, lty = "dashed", lwd = 2, col = "green")
```

```{r spline-lm-5knots}
# Note: this is a linear model, not logistic
spline1_5knots <- lm(y ~ bs(a, bc='cr', k=5), data = data_trim_exposure)
spline_pred1_5knots <- predict(spline1_5knots, newdata = list(a = a_grid), se = T)
plot(a_grid, spline_pred1_5knots$fit, type = "l", col = "red", lwd = 3)
lines(a_grid, spline_pred1_5knots$fit + 2*spline_pred1_5knots$se.fit, lty = "dashed", lwd = 2, col = "green")
lines(a_grid, spline_pred1_5knots$fit - 2*spline_pred1_5knots$se.fit, lty = "dashed", lwd = 2, col = "green")
```

```{r spline-mgcv-bam-3-knots}
# model 1: exposure only
# plot spline
spline_exposure_only <- mgcv::bam(y~ s(a, bs='cr', k=3), data = data_trim_exposure, family=binomial(link="logit"))
plot(spline_exposure_only)

# calculate global max (change point)
plot <- plot(spline_exposure_only)
cutoff <- plot[[1]]$x[which.max(plot[[1]]$fit)]
# data_binary_exposure <- get_binary_exposure_continuous_confounders_dataset("mean_total_miles", F, cutoff)

# plot predicted log odds
pred_spline_exposure_only <- predict(spline_exposure_only, newdata = list(a = a_grid), se = T)
plot(a_grid, pred_spline_exposure_only$fit, type = "l", col = "red", lwd = 3, xlab = "Mean minimum distance to gun dealer (km)", ylab = "Log odds (log(p/(1-p))")
lines(a_grid, pred_spline_exposure_only$fit + 2*pred_spline_exposure_only$se.fit, lty = "dashed", lwd = 2, col = "green")
lines(a_grid, pred_spline_exposure_only$fit - 2*pred_spline_exposure_only$se.fit, lty = "dashed", lwd = 2, col = "green")

# calculate bootstrap SE estimate for predicted probability
set.seed(100)
B <- 50 # number of bootstrap samples
n <- nrow(data_trim_exposure)
boot_indices <- matrix(sample(1:n, n * B, replace=T), nrow=B, ncol=n)
boot_a <- apply(boot_indices, c(1,2), function(i) data_trim_exposure$a[i])
boot_y <- apply(boot_indices, c(1,2), function(i) data_trim_exposure$y[i])

inverse_logit_spline_exposure_only_boot <- function(boot_row, n_knots){
  df <- data.frame(a = boot_a[boot_row, ], y = boot_y[boot_row, ])
  spline <- mgcv::bam(y~ s(a, bs='cr', k=n_knots), data = df, family=binomial(link="logit"))
  pred <- predict(spline, newdata = list(a = a_grid), se = F)
  return(inverse_logit(pred))
}

boot_thetas <- sapply(1:B, inverse_logit_spline_exposure_only_boot, n_knots = 3)
boot_se <- apply(boot_thetas, 1, sd) # for each value of a in a_grid, calculate sd(boot_thetas)

# plot predicted probability
plot(a_grid, inverse_logit(pred_spline_exposure_only$fit), type = "l", col = "red", lwd = 3, xlab = "Mean minimum distance to gun dealer (km)", ylab = "Probability of school shooting")
lines(a_grid, inverse_logit(pred_spline_exposure_only$fit) + 2*boot_se, lty = "dashed", lwd = 2, col = "green")
lines(a_grid, inverse_logit(pred_spline_exposure_only$fit) - 2*boot_se, lty = "dashed", lwd = 2, col = "green")

# model 2: exposure and Census division number (1-9)
spline_exposure_and_division <- mgcv::bam(y~ s(a, bs='cr', k=3) + census_division_number, data = data_trim_exposure, family=binomial(link="logit"))
plot(spline_exposure_and_division)

# model 3: all covariates
spline_exposure_with_covariates <- mgcv::bam(y ~ s(a, bs='cr', k=3) + census_division_number + total_population_2020 + housing_units_per_sq_meter + Tract_Area_sq_meters + log_median_hh_income + schools_per_sq_meter + log_median_hh_income_15to24 + total_crime_2021 + dealers_per_sq_meter + mental_health_index + daytime_pop_2021 + prop_white_only + prop_black_only + prop_asian_only + prop_multiracial + prop_hispanic_latino + prop_food_stamps_2019 + prop_public_assist_income_2019 + prop_below_poverty_2019 + prop_hunted_with_shotgun_2021 + prop_bachelor_deg_25plus_2021 + prop_grad_deg_25plus_2021 + prop_unemployed_2021 + prop_unemployed_16to24_2021 + prop_institutional_group + prop_noninstitutional_group + prop_18plus + prop_without_vehicles_2019, data = data_trim_exposure, family=binomial(link="logit"))
plot(spline_exposure_with_covariates)

# calculate global max (change point)
plot <- plot(spline_exposure_with_covariates)
cutoff <- plot[[1]]$x[which.max(plot[[1]]$fit)]
# data_binary_exposure <- get_binary_exposure_continuous_confounders_dataset("mean_total_miles", F, cutoff)
```

```{r spline-mgcv-bam-5-knots}
# model 1: exposure only
spline_exposure_only_5knots <- mgcv::bam(y~ s(a, bs='cr', k=5), data = data_trim_exposure, family=binomial(link="logit"))
plot(spline_exposure_only_5knots)

# plot predicted log odds
pred_spline_exposure_only_5knots <- predict(spline_exposure_only_5knots, newdata = list(a = a_grid), se = T)
plot(a_grid, pred_spline_exposure_only_5knots$fit, type = "l", col = "red", lwd = 3, xlab = "Mean minimum distance to gun dealer (km)", ylab = "Log odds (log(p/(1-p))")
lines(a_grid, pred_spline_exposure_only_5knots$fit + 2*pred_spline_exposure_only_5knots$se.fit, lty = "dashed", lwd = 2, col = "green")
lines(a_grid, pred_spline_exposure_only_5knots$fit - 2*pred_spline_exposure_only_5knots$se.fit, lty = "dashed", lwd = 2, col = "green")

# plot predicted probability
boot_thetas_5knots <- sapply(1:B, inverse_logit_spline_exposure_only_boot, n_knots = 5)
boot_se_5knots <- apply(boot_thetas_5knots, 1, sd) # check margin
plot(a_grid, inverse_logit(pred_spline_exposure_only_5knots$fit), type = "l", col = "red", lwd = 3, xlab = "Mean minimum distance to gun dealer (km)", ylab = "Probability of school shooting")
lines(a_grid, inverse_logit(pred_spline_exposure_only_5knots$fit) + 2*boot_se, lty = "dashed", lwd = 2, col = "green")
lines(a_grid, inverse_logit(pred_spline_exposure_only_5knots$fit) - 2*boot_se, lty = "dashed", lwd = 2, col = "green")

# model 2: exposure and Census division number (1-9)
spline_exposure_and_division_5knots <- mgcv::bam(y~ s(a, bs='cr', k=5) + census_division_number, data = data_trim_exposure, family=binomial(link="logit"))
plot(spline_exposure_and_division_5knots)

# model 3: all covariates
spline_exposure_with_covariates_5knots <- mgcv::bam(y ~ s(a, bs='cr', k=5) + census_division_number + total_population_2020 + housing_units_per_sq_meter + Tract_Area_sq_meters + log_median_hh_income + schools_per_sq_meter + log_median_hh_income_15to24 + total_crime_2021 + dealers_per_sq_meter + mental_health_index + daytime_pop_2021 + prop_white_only + prop_black_only + prop_asian_only + prop_multiracial + prop_hispanic_latino + prop_food_stamps_2019 + prop_public_assist_income_2019 + prop_below_poverty_2019 + prop_hunted_with_shotgun_2021 + prop_bachelor_deg_25plus_2021 + prop_grad_deg_25plus_2021 + prop_unemployed_2021 + prop_unemployed_16to24_2021 + prop_institutional_group + prop_noninstitutional_group + prop_18plus + prop_without_vehicles_2019, data = data_trim_exposure, family=binomial(link="logit"))
plot(spline_exposure_with_covariates_5knots)

# calculate global max (change point)
plot <- plot(spline_exposure_with_covariates_5knots)
cutoff <- plot[[1]]$x[which.max(plot[[1]]$fit)]
# data_binary_exposure <- get_binary_exposure_continuous_confounders_dataset("mean_total_miles", F, cutoff)
```

```{r spline-gnm, eval=F}
# To Do: Fix error (Error in s(a, bs = "cr", k = 3) : unused arguments (bs = "cr", k = 3))
gnm_spline_exposure_only <- gnm(y~ s(a, bs='cr', k=3), data = data_trim_exposure, family=binomial(link="logit"))
plot(gnm_spline_exposure_only)
```

Plot density of exposure (trimmed at 95th percentile), subsetting by outcome.
```{r density-plots}
# Note: Green is outcome == 1, Blue is outcome == 0

ffx <- density(data_trim_exposure$a[data_trim_exposure$y == 0])$x
ff0 <- density(data_trim_exposure$a[data_trim_exposure$y == 0])$y
ff1 <- density(data_trim_exposure$a[data_trim_exposure$y == 1])$y
plot(ffx, ff1, xlab = "Mean Minimum Distance to Gun Dealer (km)", ylab = "Density", main = "", col = "green", type = "l", lwd = 2)
lines(ffx, ff0, col = "blue", lwd = 2)
# rug(data_trim_exposure$a[data_trim_exposure$y == 0], ticksize = 0.1, lwd = 2, col = "blue") # too crowded
rug(data_trim_exposure$a[data_trim_exposure$y == 1], ticksize = 0.05, lwd = 2, col = "green")
legend("topright", col = c("green", "blue"), legend = c("At least 1 school shooting", "No school shootings"), lty = 1)
```


